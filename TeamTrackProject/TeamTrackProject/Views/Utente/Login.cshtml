@{
    ViewData["Title"] = "Login";
}

<h2>@ViewData["Title"]</h2>

<form id="loginForm">
    <div class="form-group">
        <label for="email" class="control-label">Email</label>
        <input type="email" id="email" name="email" class="form-control" required />
        <span id="emailError" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="password" class="control-label">Password</label>
        <input type="password" id="password" name="password" class="form-control" required />
        <span id="passwordError" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Accedi</button>
</form>

<div class="mt-3">
    <p>Non hai un account? <a href="/Utente/Registrazione">Registrati</a></p>
</div>

@section Scripts {
    <script>
        document.getElementById('loginForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new URLSearchParams();
            formData.append('email', document.getElementById('email').value);
            formData.append('password', document.getElementById('password').value);

            fetch('http://localhost:5250/api/Utente/Login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.UserId) {
                    localStorage.setItem('userId', data.UserId);
                    localStorage.setItem('userRole', document.getElementById('ruolo').value);

                    alert(data.Message);
                    window.location.href = "/Home/Index";
                } else {
                    document.getElementById('emailError').innerText = data.message || 'Errore durante il login';
                }
            })
            .catch((error) => {
                console.error('Errore nel login:', error);
                document.getElementById('emailError').innerText = 'Errore nel login, per favore riprova.';
            });
        });
    </script>
}
