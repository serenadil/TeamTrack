@{
    ViewData["Title"] = "Registrazione";
}

<h2>@ViewData["Title"]</h2>

<form id="registrazioneForm">
    <div class="form-group">
        <label for="email" class="control-label">Email</label>
        <input type="email" id="email" name="email" class="form-control" required />
        <span id="emailError" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="password" class="control-label">Password</label>
        <input type="password" id="password" name="password" class="form-control" required />
        <span id="passwordError" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="ruolo" class="control-label">Ruolo</label>
        <select id="ruolo" name="ruolo" class="form-control">
            <option value="0">Admin</option>
            <option value="1">User</option>
        </select>
    </div>

    <div class="form-group">
        <label for="nome" class="control-label">Nome</label>
        <input type="text" id="nome" name="nome" class="form-control" required />
        <span id="nomeError" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Registrati</button>
</form>

<div class="mt-3">
    <p>Hai già un account? <a href="/Utente/Login">Accedi</a></p>
</div>

@section Scripts {
    <script>
        document.getElementById('registrazioneForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new URLSearchParams();
            formData.append('email', document.getElementById('email').value);
            formData.append('password', document.getElementById('password').value);
            formData.append('ruolo', document.getElementById('ruolo').value);
            formData.append('nome', document.getElementById('nome').value);

            fetch('http://localhost:5250/api/Utente/Registrazione', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => response.json())
           .then(data => {
                if (data.userId) {  
                    localStorage.setItem('userId', data.userId); 
                    localStorage.setItem('userRole', document.getElementById('ruolo').value); 

                    alert(data.Message); 
                    window.location.href = "/Home/Index"; 
                } else {
                    document.getElementById('emailError').innerText = data.message || 'Errore durante la registrazione';
                }
            })
            .catch((error) => {
                console.error('Errore nella registrazione:', error);
                document.getElementById('emailError').innerText = 'Errore nella registrazione, per favore riprova.';
            });
        });
    </script>
}
